---
title: "ASHA 2023 Listening Effort Data Analysis"
author: "Micah E. Hirsch"
date: "2023-10-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose

The purpose of this document is to run preliminary analyses and visualizations for this project. These results were prepared specifically for a poster presentation at the the 2023 Annual American Speech Language Hearing Association Convention being held in Boston, MA in November 2023.

```{r, include = F, warning = F, message = F}

# Load Needed Packages
library(rio) # install.packages("rio")
library(tidyverse) # install.packages("tidyverse")
# Need remotes package to install gazer and saccades
library(remotes) # install.packages("remotes")
library(gazer) # remotes::install_github("dmirman/gazer")
library(saccades) # remotes::install_github("tmalsburg/saccades/saccades")
library(zoo) # install.packages("zoo")
library(ggpubr)
library(gt) # install.packages("gt")
library(glmmTMB) # install.packages("glmmTMB")
library(performance) # install.packages("performance")

```

# Descriptive Statistics

## Participant Demographics

First, we will present the demographics of our listeners To date, we recruited 20 listeners to participate in the study. Three listeners were removed from the analysis. One listener decided to withdraw from the study, so their data was removed from the database. For the other two participants, pupillometry data was either not recorded or lost due to instrumental issues. Therefore, for this analysis, we have 17 participants. The descriptive information for these participants are presented below. 

```{r}

# Load in dataset for listener demographics

listener_demo <- rio::import("Cleaned Data/cleaned_listener_demo.csv") 

```

## Speaker Intelligibility and Phrase Accuracy

### Mean Speaker Intelligibility

Across all trials in the study, the intelligibility level for each of the speaker is reported below.  Across listeners, the mean intelligibility for the ALS speaker was 81.08% with a standard deviation of 3.86. For the control speaker, the mean intelligibility level was 93.62% with a standard deviation of 2.90.

```{r}

# Load in cleaned data for pupil and perceived listening effort data

data <- rio::import("Cleaned Data/cleaned_data.csv") %>%
  # removing trials with missing rep accuracy: 3 trials removed
  dplyr::mutate(rep_acc = ifelse(rep_acc == "", NA, rep_acc)) %>%
  dplyr::filter(!is.na(rep_acc)) %>%
  # Releveling speaker variable
  dplyr::mutate(speaker = as.factor(speaker),
                speaker = fct_relevel(speaker, "Control", "ALS")) %>%
  # Creating a trial variable that codes trial 6 (i.e. the first experimental trial) as 0.
  dplyr::mutate(trial_c = trial - 6) 

intel_df <- data %>%
  dplyr::select(subject, trial, speaker, correct_words, target_number, rep_acc) %>%
  dplyr::distinct()

intel_byListener <- intel_df %>%
  dplyr::group_by(speaker, subject) %>%
  dplyr::summarize(Intelligibility = sum(correct_words)/sum(target_number)*100)

intel_byListener %>%
  dplyr::group_by(speaker) %>%
  dplyr::summarize("Mean Intelligibility" = mean(Intelligibility), SD = sd(Intelligibility))


```

### Phrase Accuracy

```{r}

# Calculating repetition accuracy descriptive data

rep_acc <- intel_df %>%
  dplyr::group_by(speaker, rep_acc) %>%
  dplyr::summarize(n = n()) %>%
  tidyr::pivot_wider(names_from = rep_acc,
                     values_from = n) %>%
  dplyr::mutate(percent_accurate = accurate/(accurate + inaccurate)*100)

rep_acc

```


# Perceived Listening Effort Ratings

## Descriptives

```{r}

perceived_effort_df <- data %>%
  dplyr::select(subject, trial, speaker, effort_rating, rep_acc, code) %>%
  dplyr::distinct() %>%
  # For this particular analysis, we are just looking at results for accurate repetition
  # However, the final project will look at rep_acc too
  dplyr::filter(rep_acc == "accurate")

per_effort_des <- perceived_effort_df %>%
  dplyr::group_by(speaker) %>%
  dplyr::summarize(per_effort = mean(effort_rating), 
                   sd = sd(effort_rating, na.rm = T),
                   se = sd/sqrt(n()))

per_effort_des

```

### Visualization

```{r}

per_effort_des %>%
  ggplot() +
   aes(x = speaker,
      y = per_effort,
      color = speaker,
      fill = speaker) +
  geom_bar(stat = "identity", alpha = 0.6) +
  geom_errorbar(aes(x = speaker, ymin = per_effort - se, ymax = per_effort + se), width = 0.4) +
  labs(x = "Speaker", y = "Perceived Listening Effort Rating") +
  theme_bw() +
  theme(legend.position = "none", aspect.ratio = 1)

```

## Perceived Listening Effort Model

### Fully Unconditional Model

```{r}

m0 <- glmmTMB(effort_rating ~ 1 + (1|subject) + (1|code), data = perceived_effort_df)

summary(m0)

performance::icc(m0)

```

## Model 1

Adding the centered trial random slope 

```{r}

m1 <- glmmTMB(effort_rating ~ 1 + (trial_c|subject) + (trial_c|code), data = perceived_effort_df)

summary(m1)

anova(m0, m1)

```
## Model 2

Adding trial as a fixed effect

```{r}

m2 <- glmmTMB(effort_rating ~ trial_c + (trial_c|subject) + (trial_c|code), data = perceived_effort_df)

summary(m2)

anova(m1, m2)

```

## Model 3

```{r}

m3 <- glmmTMB(effort_rating ~ trial_c + speaker + (trial_c|subject) + (trial_c|code), data = perceived_effort_df)

summary(m3)

anova(m2, m3)

```

## Final Model

```{r}

per_effort_model_final <- glmmTMB(effort_rating ~ speaker + (trial_c|subject) + (trial_c|code), data = perceived_effort_df)

summary(per_effort_model_final)

# Removing unneeded items from the environment

rm(m0, m1, m2, m3)

```

# Pupil Dilation

## Descriptives and Visualization

```{r}

data %>%
  # For this analysis, we are only looking at accurate repetition trials
  dplyr::filter(rep_acc == "accurate") %>%
  dplyr::group_by(timebins, speaker) %>%
  dplyr::summarize(pupil_dilation = mean(pupil.binned, na.rm = T),
                   pupil_se = sd(pupil.binned, na.rm = T)/sqrt(n())) %>%
  ggplot() +
  aes(x = timebins,
      y = pupil_dilation,
      color = speaker,
      fill = speaker) +
  geom_ribbon(aes(ymin = pupil_dilation - pupil_se, ymax = pupil_dilation + pupil_se), alpha = .3) +
  geom_line() +
  coord_cartesian(xlim = c(0,5000), ylim = c(-100, 200)) +
  labs(x = "Time (ms)", y = "Pupil Dilation (arbitrary units)", fill = "Speaker", color = "Speaker") +
  theme_bw() + 
  theme(legend.position = "bottom", aspect.ratio = 1)

```

# Fully Unconditional Model

```{r}

# Specifying the region of interest for analysis (500 ms to 1000 ms after relative offset of the trial)

pupil_roi <- data %>%
  # For this analysis, we are only analyzing pupil dilation for accurate responses
  dplyr::filter(rep_acc == "accurate") %>%
  # filtering out timebins below 500 (i.e., keeping timebins above 500 ms)
  dplyr::filter(timebins >= 500) %>%
  dplyr::group_by(subject, trial) %>%
  dplyr::filter(timebins <= max(timebins) - 2000) %>%
  ungroup() %>%
  # For the purpose of modeling, we are centering time at 500 ms (i.e. the beginning ROI time)
  dplyr::mutate(time_c = timebins - 500)

# Creating polynomial variables for model

pupil_roi <- gazer::code_poly(pupil_roi, predictor = "time_c", 
                              poly.order = 3, orthogonal = T, draw.poly = F)

# specifying unconditional growth model for pupil data

m0 <- glmmTMB(pupil.binned ~ poly1 + poly2 + poly3 + 
                (poly1 + poly2 + poly3|subject) + 
                (poly1 + poly2 +poly3|code), 
              data = pupil_roi)

summary(m0)

performance::icc(m0)

```

