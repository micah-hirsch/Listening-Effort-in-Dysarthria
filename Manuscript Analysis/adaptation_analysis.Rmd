---
title: 'Exploratory Analyses: Adaptation'
author: "Micah E. Hirsch"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose

This document contains the code and results for an exploratory analysis done with the data collected from this study. Specifically, this document reports findings about change in listening effort (measured by perceived listening effort ratings and pupil dilation) across the study trials. 

```{r, echo = F, warning = F, message = F}

library(rio) # install.packages("rio")
library(tidyverse) # install.packages("tidyverse")
library(mgcv) # install.packages("mgcv")
library(itsadug) # install.packages("itsadug")
library(ggpubr) # installl.packages("ggpubr")
library(gt) # install.packages("gt")
library(gtsummary) # install.packages("gtsummary")
library(glmmTMB) # install.packages("glmmTMB")
library(performance) # install.packages("performance")
library(sjPlot) # install.packages("sjPlot")

```


# Proportion of Correct Responses per Trial

```{r, warning = F, message = F}

# Loading in Phrase Repetition Accuracy Data
phrase_acc <- rio::import("Cleaned Data/repetition_accuracy.csv") |>
  dplyr::select(subject, trial, targetphrase, initial_response, target_number, correct_words_initial, rep_acc) |>
  dplyr::mutate(rep_acc = ifelse(initial_response == "missing data", NA, 
                                 ifelse(target_number == correct_words_initial, "accurate", "inaccurate"))) |>
  dplyr::select(!c(targetphrase, initial_response))

# Loading in PLE data and merging transcription accuracy with it
ple_data <- rio::import("Cleaned Data/cleaned_ple_data.csv") |>
  dplyr::left_join(phrase_acc, by = c("subject", "trial")) |>
  dplyr::mutate(speaker = factor(speaker, levels = c("Control", "ALS")),
                trial_c = trial - 6,
                rep_acc = factor(rep_acc, levels = c("accurate", "inaccurate"))) |>
  dplyr::filter(!is.na(rep_acc)) |>
  dplyr::filter(effort_rating > 0)

my_pal <- c("#4E4187", "#3083DC", "#F8FFE5", "#7DDE92", "#2EBFA5")

rep_acc_df <- ple_data |>
  dplyr::select(subject, trial_c, speaker, rep_acc) 

rep_acc_df |>
  dplyr::mutate(trial_c = trial_c + 1) |>
  dplyr::group_by(speaker, trial_c, rep_acc) |>
  dplyr::summarize(n = n()) |>
  dplyr::ungroup() |>
  tidyr::pivot_wider(names_from = "rep_acc",
                     values_from = "n") |>
  dplyr::mutate(accurate = ifelse(is.na(accurate), 0, accurate),
                inaccurate = ifelse(is.na(inaccurate), 0, inaccurate),
                prop_accurate = accurate/(accurate + inaccurate)) |>
  ggplot() +
  aes(x = trial_c,
      y = prop_accurate,
      group = speaker,
      color = speaker,
      fill = speaker) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(y = "Proportion of Accurate Responses",
       x = "Trial Number") +
  theme_bw() +
  theme(legend.position = "bottom",
        aspect.ratio = 1) +
  scale_color_manual(values = c(my_pal[1], my_pal[5])) +
  scale_fill_manual(values = c(my_pal[1], my_pal[5])) 

ggsave("Figures/acc_response_plot.png", plot = last_plot())

```

```{r, warning = F, message = F}

rep_acc_df <- rep_acc_df |>
  dplyr::mutate(accurate = ifelse(rep_acc == "accurate", 1, 0))

rep_acc_mod <- glmmTMB(accurate ~ trial_c*speaker + (trial_c|subject), family = "binomial", data = rep_acc_df)

sjPlot::tab_model(rep_acc_mod, transform = NULL, show.est = TRUE, show.se = TRUE,
                  pred.labels = c("Intercept", "Trial Order", "Speaker [ALS]", 
                                  "Trial Order * Speaker [ALS]"),
                  dv.labels = "Perceived Listening Effort",
                  file = "Tables/rep_acc_model.html")

```


# Perceived Listening Effort

## PLE Models

### Model 5

```{r, message = F, warning = F}


m5_ple <- glmmTMB(effort_rating ~ trial_c + speaker + rep_acc + speaker*rep_acc + (trial_c|subject) + (trial_c|code), data = ple_data)
sjPlot::tab_model(m5_ple,
                  pred.labels = c("Intercept", "Trial Order", "Speaker [ALS]", "Repetition Accuracy [Inaccurate]",
                                  "Speaker [ALS] * Repetition Accuracy [Inaccurate]"),
                  dv.labels = "Perceived Listening Effort")

```


### Model 6

```{r, message = F, warning = F}

m6_ple <- glmmTMB(effort_rating ~ trial_c + speaker + rep_acc + speaker*rep_acc + 
                    speaker*trial_c + (trial_c|subject) + (trial_c|code), data = ple_data)
sjPlot::tab_model(m6_ple,
                  pred.labels = c("Intercept", "Trial Order", "Speaker [ALS]", "Repetition Accuracy [Inaccurate]",
                                  "Speaker [ALS] * Repetition Accuracy [Inaccurate]", "Trial Order * Speaker [ALS]"),
                  dv.labels = "Perceived Listening Effort")

performance::test_performance(m5_ple, m6_ple)

```

### Model 7

```{r, message = F, warning = F}

m7_ple <- glmmTMB(effort_rating ~ trial_c + speaker + rep_acc + speaker*rep_acc + 
                    speaker*trial_c + rep_acc*trial_c + (trial_c|subject) + (trial_c|code), data = ple_data)
sjPlot::tab_model(m7_ple,
                  pred.labels = c("Intercept", "Trial Order", "Speaker [ALS]", "Repetition Accuracy [Inaccurate]",
                                  "Speaker [ALS] * Repetition Accuracy [Inaccurate]", "Trial Order * Speaker [ALS]",
                                  "Trial Order * Repetition Accuracy [Inaccurate]"),
                  dv.labels = "Perceived Listening Effort")

performance::test_performance(m5_ple, m7_ple)

```

### Model 8

```{r, message = F, warning = F}

m8_ple <- glmmTMB(effort_rating ~ trial_c + speaker + rep_acc + speaker*rep_acc + 
                    speaker*trial_c + rep_acc*trial_c +  speaker*rep_acc*trial_c + (trial_c|subject) + (trial_c|code), data = ple_data)
sjPlot::tab_model(m8_ple,
                  pred.labels = c("Intercept", "Trial Order", "Speaker [ALS]", "Repetition Accuracy [Inaccurate]",
                                  "Speaker [ALS] * Repetition Accuracy [Inaccurate]", "Trial Order * Speaker [ALS]",
                                  "Trial Order * Repetition Accuracy [Inaccurate]", "Trial Order * Speaker * Repetition Accuracy"),
                  dv.labels = "Perceived Listening Effort")

performance::test_performance(m5_ple, m8_ple)

```



```{r, eval = F, message = F, warning = F}

sjPlot::tab_model(m5_ple, m6_ple, m7_ple, m8_ple, show.ci = F,
                  pred.labels = c("Intercept", "Trial Order", "Speaker [ALS]", "Repetition Accuracy [Inaccurate]",
                                  "Speaker [ALS] * Repetition Accuracy [Inaccurate]", "Trial Order * Speaker [ALS]",
                                  "Trial Order * Repetition Accuracy [Inaccurate]", "Trial Order * Speaker * Repetition Accuracy"),
                  dv.labels = c("Model 5", "Model 6", "Model 7", "Model 8"),
                 file = "Tables/ple_adaptation_models.html")

```


## Plot

```{r, warning = F, message = F}

ple_data |>
  dplyr::mutate(trial_c = trial_c + 1) |>
  dplyr::group_by(speaker, rep_acc, trial_c) |>
  dplyr::summarize(per_effort = mean(effort_rating, na.rm = T), 
                   sd = sd(effort_rating, na.rm = T),
                   se = sd/sqrt(n())) |>
  ggplot() +
   aes(x = trial_c,
       y = per_effort,
       group = speaker,
       color = speaker,
       fill = speaker) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Trial", y = "Perceived Listening Effort Rating") +
  facet_wrap("rep_acc") +
  theme_bw() +
  theme(legend.position = "bottom",
        aspect.ratio = 1) +
  scale_color_manual(values = c(my_pal[1], my_pal[5])) +
  scale_fill_manual(values = c(my_pal[1], my_pal[5]))

ggsave("Figures/ple_trial_plot.png", plot = last_plot())

```


```{r}

rm(m5_ple, m6_ple, m7_ple, m8_ple, rep_acc_df, rep_acc_mod)

```


# Pupil Dilation

## Plot

```{r}

pupil_df <- rio::import("Cleaned Data/cleaned_pupil_data_normalized.csv") |>
  # Merging phrase accuracy information with df
  dplyr::left_join(phrase_acc, by = c("subject", "trial")) |>
  # Filter out trials with missing phrase repetition data 
  dplyr::filter(!is.na(rep_acc))

pupil_df <- pupil_df |>
  dplyr::mutate(speaker = factor(speaker, levels = c("Control", "ALS")),
                rep_acc = factor(rep_acc, levels = c("accurate", "inaccurate")),
                phrase = as.factor(code),
                listener = as.factor(subject),
                condition = case_when(speaker == "Control" & rep_acc == "accurate" ~ "Control Accurate",
                                      speaker == "Control" & rep_acc == "inaccurate" ~ "Control Inaccurate",
                                      speaker == "ALS" & rep_acc == "accurate" ~ "ALS Accurate",
                                      TRUE ~ "ALS Inaccurate"),
                condition = factor(condition, 
                                   levels = c("Control Accurate", "Control Inaccurate", "ALS Accurate", "ALS Inaccurate")),
                trial_c = trial - 6) |>
  dplyr::group_by(listener, speaker) |>
  dplyr::mutate(num_points = n()) |>
  dplyr::mutate(start_event = c(TRUE, rep(FALSE, each = (num_points - 1)))) |>
  ungroup()


# Extracting max pupil dilation
max_pupil <- pupil_df |>  
  dplyr::filter(time_norm >= 500) |>
  dplyr::group_by(subject, trial) |>
  # filtering out timebins 1000 ms after phrase offset
  dplyr::filter(time_norm<= max(time_norm) - 2000) |>
  dplyr::ungroup() |>
  # Getting Peak Pupil Dilation Value
  dplyr::group_by(subject, trial, speaker, code, rep_acc) |>
  dplyr::summarize(peak_pupil = max(normed_pupil)) |>
  dplyr::ungroup() |>
  dplyr::mutate(trial_c = trial - 6)

max_pupil |>
  dplyr::mutate(trial_c = trial_c + 1) |>
  dplyr::group_by(speaker, rep_acc, trial_c) |>
  dplyr::summarize(peak = mean(peak_pupil, na.rm = T), 
                   se = sd(peak_pupil, na.rm = T)/sqrt(n())) |>
  ggplot() +
  aes(x = trial_c,
      y = peak,
      color = speaker,
      fill = speaker) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Trial", y = "Peak Pupil Dilation (Arbitrary Units)") +
  facet_wrap("rep_acc") +
  theme_bw() +
  theme(legend.position = "bottom",
        aspect.ratio = 1) +
  scale_color_manual(values = c(my_pal[1], my_pal[5])) +
  scale_fill_manual(values = c(my_pal[1], my_pal[5]))
  
  
```

## LME Model: Peak Pupil

### Fully Unconditional Model

Tried running with random intercept for phrase too, but ran into singular fit issues. So it was removed. ICC = .331

```{r}

m0_pupil <- glmmTMB(peak_pupil ~ 1 + (1|subject), data = max_pupil)
sjPlot::tab_model(m0_pupil)
performance::icc(m0_pupil)

```

### Model 1

Adding trial random slope

```{r}

m1_pupil <- glmmTMB(peak_pupil ~ 1 + (trial_c|subject), data = max_pupil)
sjPlot::tab_model(m1_pupil)
performance::test_performance(m0_pupil, m1_pupil)

```

### Model 2

```{r}

m2_pupil <- glmmTMB(peak_pupil ~ trial_c + (trial_c|subject), data = max_pupil)
sjPlot::tab_model(m2_pupil)
performance::test_performance(m1_pupil, m2_pupil)

```

### Model 3

```{r}

m3_pupil <- glmmTMB(peak_pupil ~ trial_c + speaker + (trial_c|subject), data = max_pupil)
sjPlot::tab_model(m3_pupil)
performance::test_performance(m2_pupil, m3_pupil)

```

### Model 4

```{r}

m4_pupil <- glmmTMB(peak_pupil ~ trial_c + speaker + rep_acc + (trial_c|subject), data = max_pupil)
sjPlot::tab_model(m4_pupil)
performance::test_performance(m3_pupil, m4_pupil)

```

### Model 5 

```{r}

m5_pupil <- glmmTMB(peak_pupil ~ trial_c + speaker + rep_acc + speaker*rep_acc + (trial_c|subject), data = max_pupil)
sjPlot::tab_model(m5_pupil)
performance::test_performance(m4_pupil, m5_pupil)

```

### Model 5b

```{r}

m5b_pupil <- glmmTMB(peak_pupil ~ speaker + rep_acc + speaker*rep_acc + (trial_c|subject), data = max_pupil)
sjPlot::tab_model(m5b_pupil)
performance::test_performance(m5_pupil, m5b_pupil)

```


### Model 6

```{r}

m6_pupil <- glmmTMB(peak_pupil ~ trial_c + speaker + rep_acc + 
                      speaker*rep_acc + trial_c*speaker +(trial_c|subject), data = max_pupil)
sjPlot::tab_model(m6_pupil)
performance::test_performance(m4_pupil, m6_pupil)

```

### Model 7

```{r}

m7_pupil <- glmmTMB(peak_pupil ~ trial_c + speaker + rep_acc + 
                      speaker*rep_acc + trial_c*speaker + trial_c*rep_acc + (trial_c|subject), data = max_pupil)
sjPlot::tab_model(m7_pupil)
performance::test_performance(m6_pupil, m7_pupil)

```

### Model 8

```{r}

m8_pupil <- glmmTMB(peak_pupil ~ trial_c + speaker + rep_acc + 
                      speaker*rep_acc + trial_c*speaker + trial_c*rep_acc + 
                      trial_c*speaker*rep_acc + (trial_c|subject), data = max_pupil)
sjPlot::tab_model(m8_pupil)
performance::test_performance(m7_pupil, m8_pupil)

```

### Final Model with Unstandardized Estimates

```{r}

sjPlot::tab_model(m7_pupil,
                  pred.labels = c("Intercept", "Trial Order", "Speaker [ALS]", "Repetition Accuracy [Inaccurate]",
                                  "Speaker [ALS] * Repetition Accuracy [Inaccurate]", "Trial Order * Speaker [ALS]",
                                  "Trial Order * Repetition Accuracy [Inaccurate]"),
                  dv.labels = "Peak Pupil Dilation",
                  file = "Tables/peak_pupil_adapt_unstd.html")

```



### Final Model with Standardized Estimates

```{r}

m7_pupil_std <- glmmTMB(scale(peak_pupil) ~ scale(trial_c) + speaker + rep_acc + 
                      speaker*rep_acc + scale(trial_c)*speaker + scale(trial_c)*rep_acc + (trial_c|subject), data = max_pupil)
sjPlot::tab_model(m7_pupil_std,
                  pred.labels = c("Intercept", "Trial Order", "Speaker [ALS]", "Repetition Accuracy [Inaccurate]",
                                  "Speaker [ALS] * Repetition Accuracy [Inaccurate]", "Trial Order * Speaker [ALS]",
                                  "Trial Order * Repetition Accuracy [Inaccurate]"),
                  dv.labels = "Peak Pupil Dilation",
                  file = "Tables/peak_pupil_adapt_std.html")

```


```{r}

rm(m0_pupil, m1_pupil, m2_pupil, m3_pupil, m4_pupil, m5_pupil, m6_pupil, m7_pupil, m8_pupil, m5b_pupil, max_pupil)

```


## GAMM 

```{r, eval = F}

adapt_pupil <- bam(normed_pupil ~ condition +
                  s(time_norm, by = condition, k = 30) +
                  te(time_norm, trial_c, k = 30) +
                  # Random Smooth for listener
                  s(time_norm, listener, bs = 'fs', m =1),
                discrete = T,
                family = "scat",
                AR.start = start_event,
                rho = .92,
                data = pupil_df)

summary.gam(adapt_pupil)

plot_smooth(adapt_pupil,
            view = "time_norm",
            plot_all = "condition",
            rug = F, se = 1, rm.ranef = T)

```



```{r}

vis.gam(adapt_pupil, view = c("time_norm", "trial_c"), 
        cond = list(condition = "Control Accurate"), 
        theta = -45, phi = 55, color = "topo")

vis.gam(adapt_pupil, view = c("time_norm", "trial_c"), 
        cond = list(condition = "Control Inaccurate"), 
        theta = -45, phi = 55, color = "topo")

vis.gam(adapt_pupil, view = c("time_norm", "trial_c"), 
        cond = list(condition = "ALS Accurate"), 
        theta = -45, phi = 55, color = "topo")


vis.gam(adapt_pupil, view = c("time_norm", "trial_c"), 
        cond = list(condition = "ALS Inaccurate"), 
        theta = -45, phi = 55, color = "topo")
```


```{r, eval = F}

gam.check(adapt_pupil)

acf_resid(adapt_pupil)

```

